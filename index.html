<body>
<head>
<style>
    body{
        font-family: Lato;
    }
.city{
    display: inline-block;
    /*width: 380px;*/
    padding: 50px;
}
.race{
    display: inline-block;
    margin-right: 10px;
}
.race.total{
    display: none !important;
}
.cityName{
    font-size: 18px;
    font-weight: bold;
}
.raceName{
    font-size: 16px;
    text-transform: uppercase;
    font-style: italic;
    margin-top: 15px;
}
.metric{
    display: block;
}
.metric.hide, .city.hide{
    display: none;
}
.metric.noHide{
    display: block !important;
}
.city.noHide{
    display: inline-block !important;
}
.metricName{
    width: 100%;
    font-size: 30px;
    font-weight: 900;
    text-transform: uppercase;
    margin-left: 50px;

}
.dot{
    fill: #1696d2;
}
.tdot{
    fill: #696969;
}
.moe{
    fill: #73bfe2;
}
.tmoe{
    fill: #d2d2d2;
}
/*.moe.hide, .tmoe.hide{
    display: none;
}
.tdot.hide{
    fill: #353535;
}
*/
.insig{
    opacity: .2;
}
.btn{
    display: inline-block;
    padding: 10px;
    background: #d2d2d2;
    color: #000;
    cursor: pointer;
    text-transform: uppercase;
}
.btn.active{
    background: #1696d2;
    color: #fff;
}
</style>
</head>


<select id = "metrics">
    <option value ="all" >All indicators</option>
    <option value ="uninsured" selected="selected">uninsured</option>
    <option value ="insured_public">insured_public</option>
    <option value ="inc_loss">inc_loss</option>
    <option value ="expect_inc_loss">expect_inc_loss</option>
    <option value ="payment_not_conf">payment_not_conf</option>
    <option value ="food_insufficient">food_insufficient</option>
    <option value ="classes_cancelled">classes_cancelled</option>
    <option value ="depression_anxiety_signs">depression_anxiety_signs</option>
</select>

<select id = "geographies">
    <option value ="all" >All geographies</option>
    <option value ="US" selected="selected">US</option>
    <option value ="AK">AK</option>
    <option value ="AL">AL</option>
    <option value ="AR">AR</option>
    <option value ="AZ">AZ</option>
    <option value ="CA">CA</option>
    <option value ="CO">CO</option>
    <option value ="CT">CT</option>
    <option value ="DC">DC</option>
    <option value ="DE">DE</option>
    <option value ="FL">FL</option>
    <option value ="GA">GA</option>
    <option value ="HI">HI</option>
    <option value ="IA">IA</option>
    <option value ="ID">ID</option>
    <option value ="IL">IL</option>
    <option value ="IN">IN</option>
    <option value ="KS">KS</option>
    <option value ="KY">KY</option>
    <option value ="LA">LA</option>
    <option value ="MA">MA</option>
    <option value ="MD">MD</option>
    <option value ="ME">ME</option>
    <option value ="MI">MI</option>
    <option value ="MN">MN</option>
    <option value ="MO">MO</option>
    <option value ="MS">MS</option>
    <option value ="MT">MT</option>
    <option value ="NC">NC</option>
    <option value ="ND">ND</option>
    <option value ="NE">NE</option>
    <option value ="NH">NH</option>
    <option value ="NJ">NJ</option>
    <option value ="NM">NM</option>
    <option value ="NV">NV</option>
    <option value ="NY">NY</option>
    <option value ="OH">OH</option>
    <option value ="OK">OK</option>
    <option value ="OR">OR</option>
    <option value ="PA">PA</option>
    <option value ="RI">RI</option>
    <option value ="SC">SC</option>
    <option value ="SD">SD</option>
    <option value ="TN">TN</option>
    <option value ="TX">TX</option>
    <option value ="UT">UT</option>
    <option value ="VA">VA</option>
    <option value ="VT">VT</option>
    <option value ="WA">WA</option>
    <option value ="WI">WI</option>
    <option value ="WV">WV</option>
    <option value ="WY">WY</option>
    <option value ="Atlanta-Sandy Springs-Roswell, GA">Atlanta-Sandy Springs-Roswell, GA</option>
    <option value ="Boston-Cambridge-Newton, MA-NH">Boston-Cambridge-Newton, MA-NH</option>
    <option value ="Chicago-Naperville-Elgin, IL-IN-WI">Chicago-Naperville-Elgin, IL-IN-WI</option>
    <option value ="Dallas-Fort Worth-Arlington, TX">Dallas-Fort Worth-Arlington, TX</option>
    <option value ="Detroit-Warren-Dearborn, MI">Detroit-Warren-Dearborn, MI</option>
    <option value ="Houston-The Woodlands-Sugar Land, TX">Houston-The Woodlands-Sugar Land, TX</option>
    <option value ="Los Angeles-Long Beach-Anaheim, CA">Los Angeles-Long Beach-Anaheim, CA</option>
    <option value ="Miami-Fort Lauderdale-West Palm Beach, FL">Miami-Fort Lauderdale-West Palm Beach, FL</option>
    <option value ="New York-Newark-Jersey City, NY-NJ-PA">New York-Newark-Jersey City, NY-NJ-PA</option>
    <option value ="Philadelphia-Camden-Wilmington, PA-NJ-DE-MD">Philadelphia-Camden-Wilmington, PA-NJ-DE-MD</option>
    <option value ="Phoenix-Mesa-Scottsdale, AZ">Phoenix-Mesa-Scottsdale, AZ</option>
    <option value ="Riverside-San Bernardino-Ontario, CA">Riverside-San Bernardino-Ontario, CA</option>
    <option value ="San Francisco-Oakland-Hayward, CA">San Francisco-Oakland-Hayward, CA</option>
    <option value ="Seattle-Tacoma-Bellevue, WA">Seattle-Tacoma-Bellevue, WA</option>
    <option value="Washington-Arlington-Alexandria, DC-VA-MD-WV">Washington-Arlington-Alexandria, DC-VA-MD-WV</option>
</select>

<div id = "container"></div>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
<script>
d3.select("#metrics").on("change", function(){
    var m = this.value
    if(m == "all"){
        d3.selectAll(".metric").classed("hide", false)
    }else{
        d3.selectAll(".metric").classed("hide", true)
        d3.selectAll(".metric." + m).classed("hide", false)
    }
})

d3.select("#geographies").on("change", function(){
    var m = this.value.replace(/\W/g,'_')
    if(m == "all"){
        d3.selectAll(".city").classed("hide", false)
    }else{
        d3.selectAll(".city").classed("hide", true)
        d3.selectAll(".city." + m).classed("hide", false)
    }
})



var h = 350,
    w = 380;
d3.csv("data.csv")
.then(function(data){
    var nest = d3.nest()
        .key(function(d){ return d.metric })
        .entries(data)

    var metric = d3.select("#container")
        .selectAll(".metric")
        .data(nest)
        .enter().append("div")
        .attr("class", function(d){ return(d.key == "uninsured") ? "metric " + d.key : "metric hide " + d.key})
    metric.append("div")
        .attr("class", "metricName")
        .text(function(d){ return d.key })


    var city = metric
        .selectAll(".city")
        .data(function(n){   return d3.nest()
            .key(function(o){ return o.geography })
            .entries(n.values)
        })
        .enter().append("div")
        .attr("class", function(d){
          return (d.key == "US") ?  "city " + d.key.replace(/\W/g,'_') : "city hide " + d.key.replace(/\W/g,'_')
        })

    city.append("div")
        .attr("class", "cityName")
        .text(function(d){ return d.key })

    // console.log(nest)

    var race = city
    .selectAll(".race")
    .data(function(n){
        var t = n.values.filter(function(r){ return r.race_var == "total"})
        n.values.forEach(function(nv){
            nv.total = t
        })
        // console.log(n.values)
        return d3.nest()
            .key(function(o){ return o.race_var })
            .entries(n.values)

    })
    .enter().append("div")
    .attr("class", function(d){ return "race " + d.key })

    race.append("div")
        .attr("class", "raceName")
        .text(function(d){ return d.key })

    var svg = race.append("svg").attr("width",w).attr("height",h)

   var margin = {
    top: 10,
    right: 10,
    bottom: 25,
    left: 25
    },
    width = w - margin.left - margin.right,
    height = h - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var x = d3.scaleBand()
        .rangeRound([0, width])
        .padding(0)
        .domain(["wk1_2","wk2_3","wk3_4"])

    var y = d3.scaleLinear()
        .rangeRound([height, 0])
        .domain([0,1])

        g.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))

    g.append("g")
    .call(d3.axisLeft(y))

    g.selectAll(".moe")
        .data(function(d){
             return d.values
        })
        .enter().append("rect")
        .attr("class", "moe chartel")
        .attr("x", function(d){
            // console.log(d)
            return x(d.week_num)
        })
        .attr("y", function(d){
            return y(+d.moe_95_ub)
        })
        .attr("width", function(d){
            return x.bandwidth()
        })
        .attr("height", function(d){
            return y(+d.moe_95_lb) - y(+d.moe_95_ub)
        })
        .classed("insig", function(d){
            return (d.sigdiff == "0")
        })


    g.selectAll(".dot")
        .data(function(d){
             return d.values
        })
        .enter().append("circle")
        .attr("class", "dot")
        .attr("cx", function(d){
            return x(d.week_num) + x.bandwidth()*.5
        })
        .attr("cy", function(d){
            return y(+d.mean)
        })
        .attr("r", 4)
        .classed("insig", function(d){
            return (d.sigdiff == "0")
        })

    var tg = g.selectAll(".tg")
        .data(function(d){
             return d.values
        })
        .enter().append("g")
        .attr("clas","tg")
    tg.selectAll(".tdot")
        .data(function(d){
            // console.log(d)
            return d.total
        })
        .enter().append("circle")
        .attr("class", "tdot chartel hide")
        .attr("cx", function(d){
            // console.log(d)
            return x(d.week_num) + x.bandwidth()*.5
        })
        .attr("cy", function(d){
            return y(+d.mean)
        })
        .attr("r", 4)
        .classed("insig", function(d){
            return (d.sigdiff == "0")
        })

    tg.selectAll(".tmoe")
        .data(function(d){
             return d.total
        })
        .enter().append("rect")
        .attr("class", "tmoe hide chartel")
        .attr("x", function(d){
            // console.log(d)
            return x(d.week_num)
        })
        .attr("y", function(d){
            return y(+d.moe_95_ub)
        })
        .attr("width", function(d){
            return x.bandwidth()
        })
        .attr("height", function(d){
            return y(+d.moe_95_lb) - y(+d.moe_95_ub)
        })
        .classed("insig", function(d){
            return (d.sigdiff == "0")
        })

})




</script>
</body>