<body>
<head>
<style>
    body{
        font-family: Lato;
    }
.city{
    display: inline-block;
    /*width: 380px;*/
    padding: 50px;
}
.race{
    display: inline-block;
    margin-right: 10px;
}
.cityName{
    font-size: 18px;
    font-weight: bold;
}
.raceName{
    font-size: 16px;
    text-transform: uppercase;
    font-style: italic;
    margin-top: 15px;
}
.metricName{
    width: 100%;
    font-size: 30px;
    font-weight: 900;
    text-transform: uppercase;
    margin-left: 50px;

}
.dot{
    fill: #1696d2;
}
.tdot{
    fill: none;
    stroke: #353535;
    stroke-dasharray: 2;
}
.moe{
    /*fill: #1696d2;*/
    opacity: .6;
    stroke: #e3e3e3;
}
.tmoe{
    fill: none;   ;
    opacity: .2;
    stroke: #353535;
    stroke-dasharray: 5;
}   
</style>
</head>

<div id = "container"></div>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
<script>
var h = 350,
    w = 380;
d3.csv("data.csv")
.then(function(data){
    data = data.filter(function(o){ return o.metric == "uninsured"})
    var nest = d3.nest()
        .key(function(d){ return d.metric })
        .entries(data)

    var metric = d3.select("#container")
        .selectAll(".metric")
        .data(nest)
        .enter().append("div")
        .attr("class", "metric")
    metric.append("div")
        .attr("class", "metricName")
        .text(function(d){ return d.key })


    var city = metric
        .selectAll(".city")
        .data(function(n){   return d3.nest()
            .key(function(o){ return o.geography })
            .entries(n.values)
        })
        .enter().append("div")
        .attr("class", "city")
    
    city.append("div")
        .attr("class", "cityName")
        .text(function(d){ return d.key })

    // console.log(nest)

    var race = city
    .selectAll(".race")
    .data(function(n){
        var t = n.values.filter(function(r){ return r.race_var == "total"})
        n.values.forEach(function(nv){
            nv.total = t
        })
        // console.log(n.values)
        return d3.nest()
            .key(function(o){ return o.race_var })
            .entries(n.values)

    })
    .enter().append("div")
    .attr("class", "race")

    race.append("div")
        .attr("class", "raceName")
        .text(function(d){ return d.key })

    var svg = race.append("svg").attr("width",w).attr("height",h)

   var margin = {
    top: 10,
    right: 10,
    bottom: 25,
    left: 25
    },
    width = w - margin.left - margin.right,
    height = h - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var x = d3.scaleBand()
        .rangeRound([0, width])
        .padding(0)
        .domain(["wk1_2","wk2_3","wk3_4"])

    var y = d3.scaleLinear()
        .rangeRound([height, 0])
        .domain([0,1])

        g.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))

    g.append("g")
    .call(d3.axisLeft(y))
var defs = svg.append("defs")
var gradients = []
for(var i = 0; i < x.domain().length; i++){
    var gradient = defs
  .append("linearGradient")
    .attr("id", function(d){
       return d.key + "_" + d.values[0].geography.replace(/\W/g,'_')  + "_" + d.values[0].metric + "_gradient" + i
    })
    .attr("x1", "0%")
    .attr("y1", "0%")
    .attr("x2", "0%")
    .attr("y2", "100%")
    .attr("spreadMethod", "pad");



gradient.append("stop")
    .attr("offset", "0%")
    .attr("stop-color", function(dv){
        var d = dv.values[i]
        return (+d.moe_95_ub > +d.total[i].moe_95_ub) ? "#1696d2" : "#fdbf11"
    })
    .attr("stop-opacity", 1);

// gradient.append("stop")
//     .attr("offset", function(dv){
//         var d = dv.values[i]
//         return ((+d.moe_95_ub - +d.total[i].moe_95_ub) / (+d.moe_95_ub - +d.moe_95_lb)*100) + "%"
        
//     })
//     .attr("stop-color", "#696969")
//     .attr("stop-opacity", 1);


gradient.append("stop")
    .attr("offset", function(dv){
        var d = dv.values[i]
        return ((+d.moe_95_ub - +d.total[i].mean) / (+d.moe_95_ub - +d.moe_95_lb)*100) + "%"
        
    })
    .attr("stop-color", "#e3e3e3")
    .attr("stop-opacity", 1);


gradient.append("stop")
    .attr("offset", "100%")
    .attr("stop-color", "#fdbf11")
    .attr("stop-opacity", 1);
}



    g.selectAll(".moe")
        .data(function(d){
             return d.values
        })
        .enter().append("rect")
        .attr("class", "moe")
        .attr("x", function(d){
            // console.log(d)
            return x(d.week_num)
        })
        .attr("y", function(d){
            return y(+d.moe_95_ub)
        })
        .attr("width", function(d){
            return x.bandwidth()
        })
        .attr("height", function(d){
            return y(+d.moe_95_lb) - y(+d.moe_95_ub)
        })
        .style("fill", function(d, i){
            // console.log(d)
            return "url(#" + d.race_var + "_" + d.geography.replace(/\W/g,'_')  + "_" +  d.metric + "_gradient" + i + ")"
            // return "url(#gradient" + i + ")"
        })
        .style("opacity", function(d){
            return (d.sigdiff == "1") ? 1 : .2
        })


    g.selectAll(".dot")
        .data(function(d){
             return d.values
        })
        .enter().append("circle")
        .attr("class", "dot")
        .attr("cx", function(d){
            return x(d.week_num) + x.bandwidth()*.5
        })
        .attr("cy", function(d){
            return y(+d.mean)
        })
        .attr("r", 4)
        .style("opacity", function(d){
            return (d.sigdiff == "1") ? 1 : .2
        })

    var tg = g.selectAll(".tg")
        .data(function(d){
             return d.values
        })
        .enter().append("g")
        .attr("clas","tg")
    tg.selectAll(".tdot")
        .data(function(d){
            // console.log(d)
            return d.total
        })
        .enter().append("circle")
        .attr("class", "tdot")
        .attr("cx", function(d){
            // console.log(d)
            return x(d.week_num) + x.bandwidth()*.5
        })
        .attr("cy", function(d){
            return y(+d.mean)
        })
        .attr("r", 4)
        .style("opacity", function(d){
            return (d.sigdiff == "1") ? 1 : .2
        })

    tg.selectAll(".tmoe")
        .data(function(d){
             return d.total
        })
        .enter().append("rect")
        .attr("class", "tmoe")
        .attr("x", function(d){
            // console.log(d)
            return x(d.week_num)
        })
        .attr("y", function(d){
            return y(+d.moe_95_ub)
        })
        .attr("width", function(d){
            return x.bandwidth()
        })
        .attr("height", function(d){
            return y(+d.moe_95_lb) - y(+d.moe_95_ub)
        })
        .style("opacity", function(d){
            return (d.sigdiff == "1") ? 1 : .2
        })














})




</script>
</body>